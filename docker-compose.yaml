version: '3'

x-common-env: &common-env
  MD_PORT: 40456
  MD_SNAPSHOT_PORT: 40457
  REPLICATION_PORT: 40552
  REPLICATION_STREAM: 3002
  REPLICATION_ACK_PORT: 40551
  REPLICATION_ACK_STREAM: 3001
  WS_IP: 0.0.0.0
  AERON_DIR: /dev/shm/aeron-root/dir
  ZOOK_HOST: zookeeper
  ZOO_PORT_NUMBER: 2181
  ARCHIVEHOST: archive-host
  CONTROLPORT: 17000
  EVENTSPORT: 17001
  WS_PORT: 8090

services:

  trader-r:
    container_name: trader-r
    shm_size: "1gb"
    build:
      context: .
      dockerfile: trader/Dockerfile
    environment:
      CLIENT_ID: 1
      ALGO_TYPE: RANDOM
      ORDER_SERVER_HOSTS: exchange-1,exchange-2,exchange-3
      THISHOST: "trader-r"
      <<: *common-env
    hostname: trader-r
    volumes:
      - aeron-dir:/dev/shm/aeron-root
    depends_on:
      - exchange-1
      - zookeeper
    networks:
      default:
        ipv4_address: 10.43.0.31

  exchange-1:
    container_name: exchange-1
    shm_size: "1gb"
    build:
      context: .
      dockerfile: exchange/Dockerfile
    environment:
      INSTANCE_ID: "1"
      THISHOST: "exchange-1"
      <<: *common-env
    hostname: exchange-1
    volumes:
      - aeron-dir:/dev/shm/aeron-root
    depends_on:
      - archive-host
      - zookeeper
    networks:
      default:
        ipv4_address: 10.43.0.21

  exchange-2:
    container_name: exchange-2
    shm_size: "1gb"
    build:
      context: .
      dockerfile: exchange/Dockerfile
    environment:
      INSTANCE_ID: "2"
      THISHOST: "exchange-2"
      <<: *common-env
    hostname: exchange-2
    volumes:
      - aeron-dir:/dev/shm/aeron-root
    depends_on:
      - archive-host
      - zookeeper
    networks:
      default:
        ipv4_address: 10.43.0.22

  exchange-3:
    container_name: exchange-3
    shm_size: "1gb"
    build:
      context: .
      dockerfile: exchange/Dockerfile
    environment:
      INSTANCE_ID: "2"
      THISHOST: "exchange-3"
      <<: *common-env
    hostname: exchange-3
    volumes:
      - aeron-dir:/dev/shm/aeron-root
    depends_on:
      - archive-host
      - zookeeper
    networks:
      default:
        ipv4_address: 10.43.0.23

  archive-host:
    container_name: archive-host
    shm_size: "1gb"
    build:
      context: .
      dockerfile: aeron-archive-host/Dockerfile
    environment:
      DELETE_AERON_DIR: true
      <<: *common-env
    hostname: archive-host
    volumes:
      - aeron-dir:/dev/shm/aeron-root
    networks:
      default:
        ipv4_address: 10.43.0.2

  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: zookeeper
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
      - ZOO_STANDALONE_ENABLED=true
      - ZOO_PORT_NUMBER=2181
      - ZOO_SERVER_ID=1
      - ZOO_ADVERTISED_HOSTNAME=zookeeper
    hostname: zookeeper
    networks:
      default:
        ipv4_address: 10.43.0.3

volumes:
  aeron-dir:

networks:
  default:
    driver: bridge
    ipam:
      config:
        - subnet: 10.43.0.0/24




