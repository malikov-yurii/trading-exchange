version: '3.8'

x-common-exchange-env: &common-exchange-env
  MD_PORT: 40456
  MD_SNAPSHOT_PORT: 40457

  REPLICATION_PORT: 40552
  REPLICATION_STREAM: 3002

  REPLICATION_ACK_PORT: 40551
  REPLICATION_ACK_STREAM: 3001

  BABL_PERFORMANCE_MODE: LOW
  WS_IP: 0.0.0.0

services:
  zookeeper:
    image: bitnami/zookeeper:latest
    container_name: zookeeper
    environment:
      - ALLOW_ANONYMOUS_LOGIN=yes
      - ZOO_STANDALONE_ENABLED=true
      - ZOO_PORT_NUMBER=2181
    network_mode: host

  exchange-1:
    container_name: exchange-1
    image: trading-exchange:0.1.0
    environment:
      INSTANCE_ID: "1"
      WS_PORT: "8091"
      <<: *common-exchange-env
    shm_size: "512m"
    network_mode: "host"  # for multicast support

  exchange-2:
    container_name: exchange-2
    image: trading-exchange:0.1.0
    environment:
      INSTANCE_ID: "2"
      WS_PORT: "8092"
      <<: *common-exchange-env
    shm_size: "512m"
    network_mode: "host"  # for multicast support

  trader-R:
    container_name: trader-R
    image: trading-participant:0.1.0
    environment:
      - CLIENT_ID=1
      - ALGO_TYPE=RANDOM
      - "ORDER_SERVER_1_URI=ws://localhost:8091/ws"
      - "ORDER_SERVER_2_URI=ws://localhost:8092/ws"
    shm_size: "512m"
    network_mode: "host"
    depends_on:
      - exchange-1
    entrypoint: ["/bin/sh", "-c", "sleep 10 && java --add-opens=java.base/sun.nio.ch=ALL-UNNAMED -jar /app/trading-participant.jar"]

#  trader-M:
#    container_name: trader-M
#    image: trading-participant:0.1.0
#    environment:
#      - CLIENT_ID=2
#      - ALGO_TYPE=MARKET_MAKER
#      - "ORDER_SERVER_URI=ws://localhost:8091/ws"
#    shm_size: "512m"
#    network_mode: "host"
#    depends_on:
#      - exchange-1
#    entrypoint: ["/bin/sh", "-c", "sleep 10 && java --add-opens=java.base/sun.nio.ch=ALL-UNNAMED -jar /app/trading-participant.jar"]

